<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chubb France - Portail Produits SSI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="header-main">
            <div class="logo-section">
                <img src="Logo chubb.png" alt="Chubb">
                <div class="logo-text">Chubb <span>France</span></div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Produits</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statAdressable">0</div>
                    <div class="stat-label">Adressables</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statConventionnel">0</div>
                    <div class="stat-label">Conventionnels</div>
                </div>
                <button id="darkModeBtn" onclick="toggleDarkMode()" class="dark-mode-btn" title="Mode sombre">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="nav-container">
            <div class="nav-item active" data-tab="search">Catalogue</div>
            <div class="nav-item" data-tab="flashinfo">Notes Techniques</div>
            <div class="nav-item" data-tab="quote">Devis</div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="filter-group">
                <div class="sidebar-title">Fonction SSI</div>
                <div class="filter-item active" data-ssi="all">
                    <span>Tous les produits</span>
                    <span class="count" id="filterAllCount">0</span>
                </div>
                <div class="filter-item" data-ssi="detection">
                    <span>D√©tection</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="alarme">
                    <span>Alarme & Signalisation</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="centrale">
                    <span>Centrales & ECS</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="alimentation">
                    <span>Alimentation</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="declencheur">
                    <span>D√©clencheurs</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="extinction">
                    <span>Extinction</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="desenfumage">
                    <span>D√©senfumage</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="interface">
                    <span>Interfaces & Reports</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-ssi="accessoire">
                    <span>Accessoires</span>
                    <span class="count">0</span>
                </div>
            </div>

            <div class="filter-group">
                <div class="sidebar-title">Type Syst√®me</div>
                <div class="filter-item" data-type="adressable">
                    <span>Adressable</span>
                    <span class="count">0</span>
                </div>
                <div class="filter-item" data-type="conventionnel">
                    <span>Conventionnel</span>
                    <span class="count">0</span>
                </div>
            </div>

            <div class="filter-group">
                <div class="sidebar-title">Statut</div>
                <div class="filter-item" data-status="fiche">
                    <span>Avec fiche catalogue</span>
                    <span class="count">0</span>
                </div>
            </div>
        </aside>

        <!-- Content -->
        <div class="content-area">

            <!-- Search Tab -->
            <section class="content-section active" id="tab-search">
                <div class="search-bar">
                    <svg class="search-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="search-input" id="searchInput"
                        placeholder="Rechercher par code, nom ou mot-cl√© (√©tanche, DM, laser...)">
                    <span class="search-results-info" id="searchResultsInfo"></span>
                </div>
                <div class="sort-bar">
                    <span style="color:var(--text-muted);font-size:0.85rem;">Trier par :</span>
                    <button class="sort-btn active" data-sort="code" onclick="sortProducts('code')">Code</button>
                    <button class="sort-btn" data-sort="name" onclick="sortProducts('name')">Nom</button>
                    <button class="sort-btn" data-sort="price" onclick="sortProducts('price')">Prix</button>
                </div>
                <div class="products-grid" id="productsGrid"></div>
                <div class="pagination" id="pagination"></div>
            </section>

            <!-- Flash Info Tab -->
            <section class="content-section" id="tab-flashinfo">
                <h2 style="margin-bottom:20px;">Notes Techniques & Flash Info</h2>
                <div class="search-bar">
                    <svg class="search-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="search-input" id="flashSearch" placeholder="Rechercher dans les notes...">
                </div>
                <div id="flashList" style="display:flex;flex-direction:column;gap:8px;"></div>
            </section>

            <!-- Quote Tab -->
            <section class="content-section" id="tab-quote">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
                    <h2>G√©n√©rateur de Devis</h2>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-outline" onclick="showQuoteHistory()">Historique</button>
                        <button class="btn btn-outline" onclick="saveCurrentQuoteToHistory()">Sauvegarder</button>
                        <button class="btn btn-outline" onclick="addChapter()">+ Nouveau Chapitre</button>
                    </div>
                </div>
                <!-- Client Info Section -->
                <div class="client-info-section" id="clientInfoSection">
                    <div class="client-info-header" onclick="toggleClientInfo()">
                        <span>Informations Client</span>
                        <svg id="clientInfoToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="client-info-body" id="clientInfoBody">
                        <div class="client-info-grid">
                            <div class="client-field">
                                <label>Nom / Soci√©t√©</label>
                                <input type="text" id="clientName" placeholder="Nom du client" onchange="updateClientInfo()">
                            </div>
                            <div class="client-field">
                                <label>R√©f√©rence projet</label>
                                <input type="text" id="clientProject" placeholder="R√©f. projet" onchange="updateClientInfo()">
                            </div>
                            <div class="client-field" style="grid-column:1/-1;">
                                <label>Adresse</label>
                                <input type="text" id="clientAddress" placeholder="Adresse du chantier" onchange="updateClientInfo()">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="quoteContent">
                    <p style="color:var(--text-muted);">S√©lectionnez des produits depuis le catalogue pour g√©n√©rer un
                        devis.</p>
                </div>
            </section>

        </div>
    </div>

    <!-- Floating Selection Bar -->
    <div class="floating-bar" id="floatingBar">
        <span class="selected-count"><span id="selectedCount">0</span> produit(s) s√©lectionn√©(s)</span>
        <div class="floating-actions">
            <button class="btn btn-primary" onclick="openChapterSelectModal()">Ajouter au devis</button>
            <button class="btn btn-outline" style="color:white;border-color:rgba(255,255,255,0.3);"
                onclick="clearSelection()">Effacer</button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="modalCode"></div>
                    <div class="modal-product-name" id="modalName"></div>
                </div>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Chapter Selection Modal -->
    <div class="modal-overlay" id="chapterSelectModal">
        <div class="modal" style="max-width:450px;">
            <div class="modal-header">
                <div class="modal-title">Ajouter au devis</div>
                <button class="modal-close" onclick="closeChapterModal()">‚úï</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <p style="margin-bottom:16px;color:var(--text-muted);">
                    <span id="chapterModalProductCount">0</span> produit(s) s√©lectionn√©(s)
                </p>
                <p style="margin-bottom:16px;font-weight:500;">Choisir le chapitre de destination :</p>
                <div id="chapterSelectList" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;"></div>
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                    <button class="btn btn-outline" onclick="createAndAddToChapter()" style="width:100%;">
                        + Cr√©er un nouveau chapitre
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <div class="modal-title">Historique des Devis</div>
                <button class="modal-close" onclick="closeHistoryModal()">‚úï</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div id="historyList" style="display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="app_data.js"></script>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const ITEMS_PER_PAGE = 50;
        const DEBOUNCE_DELAY = 300;

        // ============================================
        // STATE
        // ============================================
        let selectedProducts = [];
        let quoteChapters = [];
        let currentSSIFilter = 'all';
        let currentTypeFilter = null;
        let currentStatusFilter = null;
        let currentPage = 1;
        let filteredProducts = [];
        let searchTimeout = null;
        let draggedChapterIdx = null;
        let currentSortField = 'code';
        let currentSortOrder = 'asc';
        let quoteClientInfo = { name: '', address: '', reference: '', project: '' };
        let darkMode = localStorage.getItem('chubb_darkMode') === 'true';

        // ============================================
        // LOCAL STORAGE - PERSISTENCE
        // ============================================
        const STORAGE_KEYS = {
            CURRENT_QUOTE: 'chubb_currentQuote',
            QUOTE_HISTORY: 'chubb_quoteHistory',
            CLIENT_INFO: 'chubb_clientInfo',
            DARK_MODE: 'chubb_darkMode',
            FREQUENT_PRODUCTS: 'chubb_frequentProducts'
        };

        function saveCurrentQuote() {
            const data = {
                chapters: quoteChapters,
                clientInfo: quoteClientInfo,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEYS.CURRENT_QUOTE, JSON.stringify(data));
        }

        function loadCurrentQuote() {
            try {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_QUOTE));
                if (data) {
                    quoteChapters = data.chapters || [];
                    quoteClientInfo = data.clientInfo || { name: '', address: '', reference: '', project: '' };
                }
            } catch (e) { console.log('Pas de devis sauvegard√©'); }
        }

        function saveQuoteToHistory(name) {
            const history = getQuoteHistory();
            const quote = {
                id: Date.now(),
                name: name || `Devis du ${new Date().toLocaleDateString('fr-FR')}`,
                chapters: JSON.parse(JSON.stringify(quoteChapters)),
                clientInfo: { ...quoteClientInfo },
                savedAt: new Date().toISOString(),
                total: quoteChapters.reduce((sum, c) => sum + c.products.reduce((s, p) => s + (parseFloat(p.price?.replace(',', '.')) || 0) * p.qty, 0), 0)
            };
            history.unshift(quote);
            // Garder les 20 derniers devis
            if (history.length > 20) history.pop();
            localStorage.setItem(STORAGE_KEYS.QUOTE_HISTORY, JSON.stringify(history));
            return quote.id;
        }

        function getQuoteHistory() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEYS.QUOTE_HISTORY)) || [];
            } catch (e) { return []; }
        }

        function loadQuoteFromHistory(id) {
            const history = getQuoteHistory();
            const quote = history.find(q => q.id === id);
            if (quote) {
                quoteChapters = JSON.parse(JSON.stringify(quote.chapters));
                quoteClientInfo = { ...quote.clientInfo };
                saveCurrentQuote();
                updateQuoteView();
            }
        }

        function deleteQuoteFromHistory(id) {
            let history = getQuoteHistory();
            history = history.filter(q => q.id !== id);
            localStorage.setItem(STORAGE_KEYS.QUOTE_HISTORY, JSON.stringify(history));
        }

        // Produits fr√©quents (bas√© sur l'usage)
        function trackProductUsage(code) {
            try {
                const freq = JSON.parse(localStorage.getItem(STORAGE_KEYS.FREQUENT_PRODUCTS)) || {};
                freq[code] = (freq[code] || 0) + 1;
                localStorage.setItem(STORAGE_KEYS.FREQUENT_PRODUCTS, JSON.stringify(freq));
            } catch (e) {}
        }

        function getFrequentProducts(limit = 10) {
            try {
                const freq = JSON.parse(localStorage.getItem(STORAGE_KEYS.FREQUENT_PRODUCTS)) || {};
                return Object.entries(freq)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, limit)
                    .map(([code]) => productIndex[code])
                    .filter(Boolean);
            } catch (e) { return []; }
        }

        // ============================================
        // DARK MODE
        // ============================================
        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem(STORAGE_KEYS.DARK_MODE, darkMode);
            applyDarkMode();
        }

        function applyDarkMode() {
            document.body.classList.toggle('dark-mode', darkMode);
            const btn = document.getElementById('darkModeBtn');
            if (btn) btn.innerHTML = darkMode ?
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>' :
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        }

        // ============================================
        // SORTING
        // ============================================
        function sortProducts(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            performSearch();
        }

        function applySorting(products) {
            return [...products].sort((a, b) => {
                let valA, valB;
                switch (currentSortField) {
                    case 'price':
                        valA = parseFloat(a.price?.replace(',', '.')) || 0;
                        valB = parseFloat(b.price?.replace(',', '.')) || 0;
                        break;
                    case 'name':
                        valA = (a.name || '').toLowerCase();
                        valB = (b.name || '').toLowerCase();
                        break;
                    default:
                        valA = a.code || '';
                        valB = b.code || '';
                }
                if (typeof valA === 'string') {
                    return currentSortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return currentSortOrder === 'asc' ? valA - valB : valB - valA;
            });
        }

        // ============================================
        // DATA INITIALIZATION
        // ============================================
        const products = appData.products;
        const flashInfo = appData.flashInfo || [];
        const stats = appData.stats;
        const ssiCategories = appData.ssiCategories;

        // Index products by code for fast lookup
        const productIndex = {};
        products.forEach(p => productIndex[p.code] = p);

        // Init stats display
        document.getElementById('statTotal').textContent = stats.total.toLocaleString();
        document.getElementById('statAdressable').textContent = stats.adressable.toLocaleString();
        document.getElementById('statConventionnel').textContent = stats.conventionnel.toLocaleString();
        document.getElementById('filterAllCount').textContent = stats.total.toLocaleString();

        // Update SSI category counts
        document.querySelectorAll('.filter-item[data-ssi]').forEach(item => {
            const ssi = item.dataset.ssi;
            if (ssi !== 'all' && ssiCategories[ssi]) {
                item.querySelector('.count').textContent = ssiCategories[ssi].count.toLocaleString();
            }
        });

        // Update type counts
        document.querySelectorAll('.filter-item[data-type]').forEach(item => {
            const type = item.dataset.type;
            const count = products.filter(p => p.type === type).length;
            item.querySelector('.count').textContent = count.toLocaleString();
        });

        // Update status counts
        const ficheCount = products.filter(p => p.hasFiche || p.url).length;
        document.querySelector('[data-status="fiche"] .count').textContent = ficheCount.toLocaleString();

        // ============================================
        // TAB NAVIGATION
        // ============================================
        document.querySelectorAll('.nav-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // ============================================
        // FILTERS
        // ============================================
        document.querySelectorAll('.filter-item[data-ssi]').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.filter-item[data-ssi]').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentSSIFilter = item.dataset.ssi;
                currentPage = 1;
                performSearch();
            });
        });

        document.querySelectorAll('.filter-item[data-type]').forEach(item => {
            item.addEventListener('click', () => {
                if (item.classList.contains('active')) {
                    item.classList.remove('active');
                    currentTypeFilter = null;
                } else {
                    document.querySelectorAll('.filter-item[data-type]').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentTypeFilter = item.dataset.type;
                }
                currentPage = 1;
                performSearch();
            });
        });

        document.querySelectorAll('.filter-item[data-status]').forEach(item => {
            item.addEventListener('click', () => {
                if (item.classList.contains('active')) {
                    item.classList.remove('active');
                    currentStatusFilter = null;
                } else {
                    document.querySelectorAll('.filter-item[data-status]').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentStatusFilter = item.dataset.status;
                }
                currentPage = 1;
                performSearch();
            });
        });

        // ============================================
        // SEARCH FUNCTIONS
        // ============================================
        function normalize(str) {
            return (str || '').toLowerCase().replace(/[\.\s\-\/\(\)\']/g, '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function performSearch() {
            const query = normalize(document.getElementById('searchInput').value);
            filteredProducts = products;

            // Text search
            if (query && query.length >= 2) {
                filteredProducts = filteredProducts.filter(p => {
                    if (normalize(p.code).includes(query)) return true;
                    if (normalize(p.name).includes(query)) return true;
                    if (p.keywords && p.keywords.some(kw => normalize(kw).includes(query))) return true;
                    return false;
                });
            }

            // SSI filter
            if (currentSSIFilter !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.ssi === currentSSIFilter);
            }

            // Type filter
            if (currentTypeFilter) {
                filteredProducts = filteredProducts.filter(p => p.type === currentTypeFilter);
            }

            // Status filter
            if (currentStatusFilter) {
                if (currentStatusFilter === 'fiche') {
                    filteredProducts = filteredProducts.filter(p => p.hasFiche || p.url);
                }
            }

            // Apply sorting
            filteredProducts = applySorting(filteredProducts);

            renderProducts();
            renderPagination();
        }

        function renderCard(product) {
            const isSelected = selectedProducts.some(p => p.code === product.code);
            let tags = '';

            if (product.type === 'adressable') tags += '<span class="tag tag-adressable">Adressable</span>';
            if (product.type === 'conventionnel') tags += '<span class="tag tag-conventionnel">Conventionnel</span>';
            if (product.cert) tags += '<span class="tag tag-certified">Certifi√©</span>';
            if (product.hasFiche || product.url) tags += '<span class="tag tag-fiche">Fiche</span>';
            if (product.disc) tags += '<span class="tag tag-disc">Arr√™t√©</span>';

            const priceDisplay = product.price ? `<div class="product-price">${product.price} ‚Ç¨</div>` : '';

            return `
            <div class="product-card" onclick="openModal('${product.code}')">
                <input type="checkbox" class="product-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();toggleSelect('${product.code}')">
                <div class="product-code">${product.code}</div>
                <div class="product-name">${product.name}</div>
                ${priceDisplay}
                <div class="product-tags">${tags}</div>
            </div>
        `;
        }

        function renderProducts() {
            const container = document.getElementById('productsGrid');
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageProducts = filteredProducts.slice(start, end);

            // Update search results info
            const info = document.getElementById('searchResultsInfo');
            info.textContent = `${filteredProducts.length.toLocaleString()} r√©sultat(s)`;

            if (pageProducts.length === 0) {
                container.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <h3>Aucun produit trouv√©</h3>
                    <p>Essayez de modifier vos crit√®res de recherche.</p>
                </div>`;
            } else {
                container.innerHTML = pageProducts.map(renderCard).join('');
            }
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            html += `<button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>¬´</button>`;
            html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>`;

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<button onclick="goToPage(1)">1</button>`;
                if (startPage > 2) html += `<span style="padding:0 8px;">...</span>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += `<span style="padding:0 8px;">...</span>`;
                html += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>`;
            html += `<button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>¬ª</button>`;
            html += `<span class="pagination-info">Page ${currentPage} / ${totalPages}</span>`;

            container.innerHTML = html;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);
            currentPage = Math.max(1, Math.min(page, totalPages));
            renderProducts();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Debounced search
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, DEBOUNCE_DELAY);
        });

        // ============================================
        // SELECTION
        // ============================================
        function toggleSelect(code) {
            const product = productIndex[code];
            const idx = selectedProducts.findIndex(p => p.code === code);
            if (idx >= 0) {
                selectedProducts.splice(idx, 1);
            } else {
                selectedProducts.push(product);
            }
            updateFloatingBar();
            renderProducts();
        }

        function updateFloatingBar() {
            const bar = document.getElementById('floatingBar');
            document.getElementById('selectedCount').textContent = selectedProducts.length;
            bar.classList.toggle('show', selectedProducts.length > 0);
        }

        function clearSelection() {
            selectedProducts = [];
            updateFloatingBar();
            renderProducts();
        }

        // ============================================
        // MODAL
        // ============================================
        function openModal(code) {
            const product = productIndex[code];
            if (!product) return;

            document.getElementById('modalCode').textContent = product.code;
            document.getElementById('modalName').textContent = product.name;

            let html = '';

            // Description (Libell√© commercial)
            if (product.desc) {
                html += '<div class="info-section"><div class="info-section-title">Description</div>';
                html += `<p style="color:var(--text-dark);line-height:1.6;margin:0;">${product.desc}</p></div>`;
            }

            // Info grid
            html += '<div class="info-section"><div class="info-section-title">Informations</div><div class="info-grid">';
            html += `<div class="info-item"><div class="info-value">${product.price || '-'}</div><div class="info-label">Prix (EUR)</div></div>`;
            html += `<div class="info-item"><div class="info-value">${product.type || '-'}</div><div class="info-label">Syst√®me</div></div>`;
            html += `<div class="info-item"><div class="info-value">${product.ssi ? ssiCategories[product.ssi]?.name : '-'}</div><div class="info-label">Fonction SSI</div></div>`;
            html += '</div></div>';

            // Fiche
            if (product.url) {
                html += '<div class="info-section"><div class="info-section-title">Fiche Technique</div>';
                html += `<a href="${product.url}" target="_blank" class="btn btn-primary"><svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> Ouvrir la fiche</a></div>`;
            }

            // Documents
            if (product.docs && product.docs.length > 0) {
                html += '<div class="info-section"><div class="info-section-title">üìö Documents associ√©s</div><div class="doc-list">';
                product.docs.forEach(d => {
                    const icon = d.type === 'certificate' ? 'üèÖ' : d.type === 'technical' ? 'üìò' : 'üìÑ';
                    html += `<a href="${d.url}" target="_blank" class="doc-item"><span class="doc-item-icon">${icon}</span>${d.title}</a>`;
                });
                html += '</div></div>';
            }

            // Keywords
            if (product.keywords && product.keywords.length > 0) {
                html += '<div class="info-section"><div class="info-section-title">Mots-cl√©s</div>';
                html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
                product.keywords.forEach(kw => {
                    html += `<span class="tag" style="background:var(--bg-light);color:var(--text-muted);">${kw}</span>`;
                });
                html += '</div></div>';
            }

            // Add to quote button
            html += `<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">
                <button class="btn btn-primary" onclick="addSingleToQuote('${product.code}')">Ajouter au devis</button>
            </div>`;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
        }

        document.getElementById('modalOverlay').onclick = e => {
            if (e.target.id === 'modalOverlay') closeModal();
        };

        function addSingleToQuote(code) {
            const product = productIndex[code];
            if (!selectedProducts.some(p => p.code === code)) {
                selectedProducts.push(product);
            }
            closeModal();
            openChapterSelectModal();
        }

        // ============================================
        // CHAPTER SELECTION MODAL
        // ============================================
        function openChapterSelectModal() {
            if (selectedProducts.length === 0) return;

            document.getElementById('chapterModalProductCount').textContent = selectedProducts.length;

            const listContainer = document.getElementById('chapterSelectList');

            if (quoteChapters.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align:center;padding:20px;color:var(--text-muted);">
                        <p>Aucun chapitre existant.</p>
                        <p style="font-size:0.9rem;margin-top:8px;">Cr√©ez un nouveau chapitre ci-dessous.</p>
                    </div>`;
            } else {
                listContainer.innerHTML = quoteChapters.map((chapter, idx) => `
                    <button class="chapter-select-btn" onclick="addToSpecificChapter(${idx})">
                        <span style="font-weight:500;">${chapter.name}</span>
                        <span style="color:var(--text-muted);font-size:0.85rem;">${chapter.products.length} produit(s)</span>
                    </button>
                `).join('');
            }

            document.getElementById('chapterSelectModal').classList.add('show');
        }

        function closeChapterModal() {
            document.getElementById('chapterSelectModal').classList.remove('show');
        }

        document.getElementById('chapterSelectModal').onclick = e => {
            if (e.target.id === 'chapterSelectModal') closeChapterModal();
        };

        function createAndAddToChapter() {
            const name = prompt('Nom du nouveau chapitre:', 'Nouveau chapitre');
            if (name) {
                quoteChapters.push({ name, products: [] });
                addToSpecificChapter(quoteChapters.length - 1);
            }
        }

        function addToSpecificChapter(chapterIdx) {
            selectedProducts.forEach(p => {
                if (!quoteChapters[chapterIdx].products.some(q => q.code === p.code)) {
                    quoteChapters[chapterIdx].products.push({ ...p, qty: 1 });
                }
            });

            // Close modal and clear selection
            closeChapterModal();
            clearSelection();

            // Navigate to quote tab
            document.querySelector('[data-tab="quote"]').click();
            updateQuoteView();
        }

        // ============================================
        // QUOTE SYSTEM
        // ============================================
        function addChapter() {
            const name = prompt('Nom du chapitre:', 'Nouveau chapitre');
            if (name) {
                quoteChapters.push({ name, products: [] });
                updateQuoteView();
            }
        }

        function updateQuoteView() {
            const container = document.getElementById('quoteContent');

            if (quoteChapters.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:60px 20px;background:white;border-radius:12px;border:2px dashed var(--border);">
                        <div style="font-size:3rem;margin-bottom:16px;">üìã</div>
                        <p style="color:var(--text-muted);margin-bottom:20px;">Aucun chapitre cr√©√©. Cr√©ez un chapitre puis ajoutez des produits.</p>
                        <button class="btn btn-primary" onclick="addChapter()">+ Cr√©er un chapitre</button>
                    </div>`;
                return;
            }

            let html = '<div id="chaptersContainer">';
            let grandTotal = 0;

            quoteChapters.forEach((chapter, chapterIdx) => {
                const chapterTotal = chapter.products.reduce((sum, p) => sum + (parseFloat(p.price?.replace(',', '.')) || 0) * p.qty, 0);
                grandTotal += chapterTotal;

                html += `
                <div class="quote-chapter" draggable="true" data-chapter="${chapterIdx}"
                    ondragstart="handleChapterDragStart(event, ${chapterIdx})"
                    ondragover="handleChapterDragOver(event)"
                    ondrop="handleChapterDrop(event, ${chapterIdx})"
                    ondragend="handleChapterDragEnd(event)">
                    <div class="chapter-header">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span class="drag-handle" style="cursor:grab;opacity:0.6;font-size:1.2rem;">‚ãÆ‚ãÆ</span>
                            <span style="font-weight:600;font-size:1.1rem;">${chapter.name}</span>
                            <button onclick="renameChapter(${chapterIdx})" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;display:flex;align-items:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        </div>
                        <div style="display:flex;align-items:center;gap:16px;">
                            <div style="display:flex;gap:4px;">
                                <button onclick="moveChapterUp(${chapterIdx})" ${chapterIdx === 0 ? 'disabled' : ''} style="background:rgba(255,255,255,0.2);border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.8rem;">‚ñ≤</button>
                                <button onclick="moveChapterDown(${chapterIdx})" ${chapterIdx === quoteChapters.length - 1 ? 'disabled' : ''} style="background:rgba(255,255,255,0.2);border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.8rem;">‚ñº</button>
                            </div>
                            <button onclick="duplicateChapter(${chapterIdx})" title="Dupliquer" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;display:flex;align-items:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                            <span style="font-size:0.85rem;opacity:0.9;">${chapter.products.length} article(s)</span>
                            <span style="font-weight:700;font-size:1.1rem;">${chapterTotal.toFixed(2)} ‚Ç¨</span>
                            <button onclick="deleteChapter(${chapterIdx})" style="background:rgba(255,0,0,0.3);border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;display:flex;align-items:center;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>
                    </div>
                    <div class="chapter-products ${chapter.products.length === 0 ? 'empty' : ''}" data-chapter="${chapterIdx}">`;

                if (chapter.products.length === 0) {
                    html += `<p style="color:var(--text-muted);font-size:0.9rem;padding:20px;">Ajoutez des produits depuis le catalogue</p>`;
                } else {
                    chapter.products.forEach((p, prodIdx) => {
                        const lineTotal = (parseFloat(p.price?.replace(',', '.')) || 0) * p.qty;
                        html += `
                        <div class="quote-product" data-chapter="${chapterIdx}" data-product="${prodIdx}">
                            <span style="opacity:0.4;">‚ãÆ‚ãÆ</span>
                            <div>
                                <div style="font-weight:500;color:var(--text-dark);font-size:0.95rem;">${p.code}</div>
                                <div style="font-size:0.8rem;color:var(--text-muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:300px;">${p.name}</div>
                            </div>
                            <input type="number" value="${p.qty}" min="1"
                                style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;text-align:center;font-size:0.9rem;"
                                onchange="updateChapterQty(${chapterIdx}, ${prodIdx}, this.value)"
                                onclick="event.stopPropagation()">
                            <div style="text-align:right;color:var(--text-muted);font-size:0.9rem;">${p.price || '-'} ‚Ç¨</div>
                            <div style="text-align:right;font-weight:600;color:var(--primary);font-size:0.95rem;">${lineTotal.toFixed(2)} ‚Ç¨</div>
                            <button onclick="removeFromChapter(${chapterIdx}, ${prodIdx}); event.stopPropagation();"
                                style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:1rem;opacity:0.6;"
                                onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6">‚úï</button>
                        </div>`;
                    });
                }

                html += '</div></div>';
            });

            html += '</div>';

            // Grand total bar
            const totalProducts = quoteChapters.reduce((sum, c) => sum + c.products.length, 0);
            html += `
            <div class="quote-total">
                <div>
                    <div style="font-size:1rem;font-weight:500;">TOTAL G√âN√âRAL HT</div>
                    <div style="font-size:0.8rem;opacity:0.8;margin-top:4px;">${totalProducts} produit(s) ‚Ä¢ ${quoteChapters.length} chapitre(s)</div>
                </div>
                <div style="font-size:2.2rem;font-weight:700;">${grandTotal.toFixed(2)} ‚Ç¨</div>
            </div>`;

            // Export buttons
            html += `
            <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="exportQuotePDF()"><svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Exporter PDF</button>
                <button class="btn btn-outline" onclick="exportQuoteExcel()"><svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg> Exporter Excel</button>
                <button class="btn btn-outline" onclick="clearQuote()" style="margin-left:auto;color:var(--danger);border-color:var(--danger);"><svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> Vider le devis</button>
            </div>`;

            container.innerHTML = html;
        }

        // ============================================
        // CHAPTER DRAG & DROP
        // ============================================
        function handleChapterDragStart(e, idx) {
            draggedChapterIdx = idx;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleChapterDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleChapterDrop(e, targetIdx) {
            e.preventDefault();
            if (draggedChapterIdx !== null && draggedChapterIdx !== targetIdx) {
                const draggedChapter = quoteChapters.splice(draggedChapterIdx, 1)[0];
                quoteChapters.splice(targetIdx, 0, draggedChapter);
                updateQuoteView();
            }
        }

        function handleChapterDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            draggedChapterIdx = null;
        }

        function moveChapterUp(idx) {
            if (idx > 0) {
                [quoteChapters[idx - 1], quoteChapters[idx]] = [quoteChapters[idx], quoteChapters[idx - 1]];
                updateQuoteView();
            }
        }

        function moveChapterDown(idx) {
            if (idx < quoteChapters.length - 1) {
                [quoteChapters[idx], quoteChapters[idx + 1]] = [quoteChapters[idx + 1], quoteChapters[idx]];
                updateQuoteView();
            }
        }

        function updateChapterQty(chapterIdx, prodIdx, val) {
            quoteChapters[chapterIdx].products[prodIdx].qty = parseInt(val) || 1;
            updateQuoteView();
        }

        function removeFromChapter(chapterIdx, prodIdx) {
            quoteChapters[chapterIdx].products.splice(prodIdx, 1);
            updateQuoteView();
        }

        function renameChapter(idx) {
            const name = prompt('Nouveau nom:', quoteChapters[idx].name);
            if (name) {
                quoteChapters[idx].name = name;
                updateQuoteView();
            }
        }

        function deleteChapter(idx) {
            if (confirm('Supprimer ce chapitre et ses produits ?')) {
                quoteChapters.splice(idx, 1);
                updateQuoteView();
            }
        }

        function clearQuote() {
            if (confirm('Vider tout le devis ?')) {
                quoteChapters = [];
                quoteClientInfo = { name: '', address: '', reference: '', project: '' };
                saveCurrentQuote();
                updateQuoteView();
                updateClientInfoFields();
            }
        }

        function duplicateChapter(idx) {
            const original = quoteChapters[idx];
            const copy = {
                name: original.name + ' (copie)',
                products: JSON.parse(JSON.stringify(original.products))
            };
            quoteChapters.splice(idx + 1, 0, copy);
            saveCurrentQuote();
            updateQuoteView();
        }

        // ============================================
        // CLIENT INFO
        // ============================================
        function toggleClientInfo() {
            const body = document.getElementById('clientInfoBody');
            const toggle = document.getElementById('clientInfoToggle');
            body.classList.toggle('collapsed');
            toggle.style.transform = body.classList.contains('collapsed') ? 'rotate(-90deg)' : '';
        }

        function updateClientInfo() {
            quoteClientInfo.name = document.getElementById('clientName')?.value || '';
            quoteClientInfo.address = document.getElementById('clientAddress')?.value || '';
            quoteClientInfo.project = document.getElementById('clientProject')?.value || '';
            saveCurrentQuote();
        }

        function updateClientInfoFields() {
            const nameField = document.getElementById('clientName');
            const addressField = document.getElementById('clientAddress');
            const projectField = document.getElementById('clientProject');
            if (nameField) nameField.value = quoteClientInfo.name || '';
            if (addressField) addressField.value = quoteClientInfo.address || '';
            if (projectField) projectField.value = quoteClientInfo.project || '';
        }

        // ============================================
        // QUOTE HISTORY
        // ============================================
        function showQuoteHistory() {
            const history = getQuoteHistory();
            const container = document.getElementById('historyList');

            if (history.length === 0) {
                container.innerHTML = `<p style="color:var(--text-muted);text-align:center;padding:40px;">Aucun devis sauvegard√©</p>`;
            } else {
                container.innerHTML = history.map(q => `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-name">${q.name}</div>
                            <div class="history-meta">${new Date(q.savedAt).toLocaleDateString('fr-FR')} ‚Ä¢ ${q.chapters?.length || 0} chapitres ‚Ä¢ ${q.total?.toFixed(2) || '0.00'} ‚Ç¨</div>
                        </div>
                        <div class="history-actions">
                            <button class="btn btn-outline" onclick="loadQuoteFromHistory(${q.id}); closeHistoryModal();">Charger</button>
                            <button class="btn btn-outline" style="color:var(--danger);border-color:var(--danger);" onclick="deleteQuoteFromHistory(${q.id}); showQuoteHistory();">Suppr.</button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('historyModal').classList.add('show');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        document.getElementById('historyModal').onclick = e => {
            if (e.target.id === 'historyModal') closeHistoryModal();
        };

        function saveCurrentQuoteToHistory() {
            if (quoteChapters.length === 0) {
                alert('Le devis est vide.');
                return;
            }
            const name = prompt('Nom du devis:', quoteClientInfo.name || `Devis du ${new Date().toLocaleDateString('fr-FR')}`);
            if (name) {
                saveQuoteToHistory(name);
                alert('Devis sauvegard√© dans l\'historique.');
            }
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        function exportQuotePDF() {
            const today = new Date().toLocaleDateString('fr-FR');
            let grandTotal = 0;

            const ref = 'DEV-' + Date.now().toString(36).toUpperCase();

            let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Devis Chubb France</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #1a1a2e; }
                    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #c41e3a; }
                    .logo { font-size: 28px; font-weight: 700; color: #c41e3a; }
                    .logo span { color: #1e3a5f; }
                    .meta { text-align: right; font-size: 12px; color: #666; }
                    .client-box { background: #f8f9fa; padding: 16px 20px; border-radius: 8px; margin-bottom: 30px; }
                    .client-title { font-size: 11px; text-transform: uppercase; color: #666; margin-bottom: 8px; font-weight: 600; }
                    .client-name { font-size: 16px; font-weight: 600; color: #1a1a2e; }
                    .client-detail { font-size: 13px; color: #666; margin-top: 4px; }
                    .chapter { margin-bottom: 30px; }
                    .chapter-header { background: linear-gradient(135deg, #1e3a5f, #2d4a6f); color: white; padding: 12px 16px; font-weight: 600; font-size: 14px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; }
                    table { width: 100%; border-collapse: collapse; }
                    th { background: #f8f9fa; padding: 10px 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; border-bottom: 2px solid #e9ecef; }
                    td { padding: 12px; border-bottom: 1px solid #e9ecef; font-size: 13px; }
                    .code { font-weight: 600; color: #1e3a5f; }
                    .text-right { text-align: right; }
                    .grand-total { background: linear-gradient(135deg, #c41e3a, #9a1830); color: white; padding: 20px; margin-top: 30px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
                    .grand-total .label { font-size: 14px; }
                    .grand-total .amount { font-size: 28px; font-weight: 700; }
                    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e9ecef; font-size: 11px; color: #666; text-align: center; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">CHUBB <span>France</span></div>
                    <div class="meta">
                        <div style="font-weight:600;font-size:18px;color:#1a1a2e;margin-bottom:4px;">DEVIS</div>
                        <div>Date: ${today}</div>
                        <div>R√©f: ${ref}</div>
                    </div>
                </div>`;

            // Client info
            if (quoteClientInfo.name || quoteClientInfo.address || quoteClientInfo.project) {
                html += `<div class="client-box">
                    <div class="client-title">Client</div>`;
                if (quoteClientInfo.name) html += `<div class="client-name">${quoteClientInfo.name}</div>`;
                if (quoteClientInfo.address) html += `<div class="client-detail">${quoteClientInfo.address}</div>`;
                if (quoteClientInfo.project) html += `<div class="client-detail">Projet: ${quoteClientInfo.project}</div>`;
                html += `</div>`;
            }

            quoteChapters.forEach(chapter => {
                if (chapter.products.length === 0) return;

                const chapterTotal = chapter.products.reduce((sum, p) => sum + (parseFloat(p.price?.replace(',', '.')) || 0) * p.qty, 0);
                grandTotal += chapterTotal;

                html += `
                <div class="chapter">
                    <div class="chapter-header">
                        <span>${chapter.name}</span>
                        <span>${chapterTotal.toFixed(2)} ‚Ç¨</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width:15%">Code</th>
                                <th style="width:45%">D√©signation</th>
                                <th style="width:10%" class="text-right">Qt√©</th>
                                <th style="width:15%" class="text-right">P.U. HT</th>
                                <th style="width:15%" class="text-right">Total HT</th>
                            </tr>
                        </thead>
                        <tbody>`;

                chapter.products.forEach(p => {
                    const lineTotal = (parseFloat(p.price?.replace(',', '.')) || 0) * p.qty;
                    html += `
                            <tr>
                                <td class="code">${p.code}</td>
                                <td>${p.name}</td>
                                <td class="text-right">${p.qty}</td>
                                <td class="text-right">${p.price || '-'} ‚Ç¨</td>
                                <td class="text-right" style="font-weight:500;">${lineTotal.toFixed(2)} ‚Ç¨</td>
                            </tr>`;
                });

                html += `
                        </tbody>
                    </table>
                </div>`;
            });

            html += `
                <div class="grand-total">
                    <div class="label">TOTAL G√âN√âRAL HT</div>
                    <div class="amount">${grandTotal.toFixed(2)} ‚Ç¨</div>
                </div>
                <div class="footer">
                    Chubb France - Devis g√©n√©r√© le ${today} - Validit√© 30 jours
                </div>
            </body>
            </html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function exportQuoteExcel() {
            const today = new Date().toLocaleDateString('fr-FR');
            const ref = 'DEV-' + Date.now().toString(36).toUpperCase();
            let grandTotal = 0;

            // G√©n√©rer un tableau HTML stylis√© compatible Excel
            let html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
            <head>
                <meta charset="UTF-8">
                <!--[if gte mso 9]>
                <xml>
                    <x:ExcelWorkbook>
                        <x:ExcelWorksheets>
                            <x:ExcelWorksheet>
                                <x:Name>Devis</x:Name>
                                <x:WorksheetOptions>
                                    <x:DisplayGridlines/>
                                </x:WorksheetOptions>
                            </x:ExcelWorksheet>
                        </x:ExcelWorksheets>
                    </x:ExcelWorkbook>
                </xml>
                <![endif]-->
                <style>
                    @page { margin: 0.5in; }
                    body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; }
                    table { border-collapse: collapse; width: 100%; }
                    .header-title { font-size: 24pt; font-weight: bold; color: #c41e3a; padding: 10px 0; }
                    .header-info { font-size: 10pt; color: #666; padding: 3px 0; }
                    .chapter-row { background-color: #1e3a5f; color: white; font-weight: bold; font-size: 12pt; }
                    .chapter-row td { padding: 10px 8px; }
                    .column-header { background-color: #f0f0f0; font-weight: bold; font-size: 10pt; text-transform: uppercase; color: #333; border-bottom: 2px solid #ccc; }
                    .column-header td { padding: 8px; }
                    .product-row td { padding: 8px; border-bottom: 1px solid #e0e0e0; vertical-align: top; }
                    .product-row:hover { background-color: #f9f9f9; }
                    .code { font-weight: bold; color: #1e3a5f; width: 120px; text-align: left; }
                    .designation { width: 350px; }
                    .qty { text-align: center; width: 80px; }
                    .price { text-align: right; width: 100px; }
                    .total { text-align: right; font-weight: 500; width: 100px; }
                    .chapter-total { text-align: right; font-size: 11pt; }
                    .grand-total-row { background-color: #c41e3a; color: white; font-weight: bold; font-size: 14pt; }
                    .grand-total-row td { padding: 15px 8px; }
                    .spacer td { height: 20px; }
                </style>
            </head>
            <body>
                <table>
                    <tr><td colspan="5" class="header-title">DEVIS CHUBB FRANCE</td></tr>
                    <tr><td colspan="5" class="header-info">Date : ${today}</td></tr>
                    <tr><td colspan="5" class="header-info">R√©f√©rence : ${ref}</td></tr>`;

            // Client info in Excel
            if (quoteClientInfo.name) {
                html += `<tr><td colspan="5" class="header-info" style="padding-top:10px;"><strong>Client :</strong> ${quoteClientInfo.name}</td></tr>`;
            }
            if (quoteClientInfo.address) {
                html += `<tr><td colspan="5" class="header-info">${quoteClientInfo.address}</td></tr>`;
            }
            if (quoteClientInfo.project) {
                html += `<tr><td colspan="5" class="header-info">Projet : ${quoteClientInfo.project}</td></tr>`;
            }

            html += `<tr class="spacer"><td colspan="5"></td></tr>`;

            quoteChapters.forEach(chapter => {
                if (chapter.products.length === 0) return;

                const chapterTotal = chapter.products.reduce((sum, p) => sum + (parseFloat(p.price?.replace(',', '.')) || 0) * p.qty, 0);
                grandTotal += chapterTotal;

                html += `
                    <tr class="chapter-row">
                        <td colspan="5">${chapter.name.toUpperCase()}</td>
                    </tr>
                    <tr class="column-header">
                        <td>Code</td>
                        <td>D√©signation</td>
                        <td style="text-align:center;">Qt√©</td>
                        <td style="text-align:right;">P.U. HT</td>
                        <td style="text-align:right;">Total HT</td>
                    </tr>`;

                chapter.products.forEach(p => {
                    const price = parseFloat(p.price?.replace(',', '.')) || 0;
                    const lineTotal = price * p.qty;
                    html += `
                    <tr class="product-row">
                        <td class="code">${p.code}</td>
                        <td class="designation">${p.name}</td>
                        <td class="qty">${p.qty}</td>
                        <td class="price">${p.price || '-'} ‚Ç¨</td>
                        <td class="total">${lineTotal.toFixed(2)} ‚Ç¨</td>
                    </tr>`;
                });

                html += `
                    <tr style="background-color:#1e3a5f;color:white;font-weight:bold;">
                        <td colspan="3"></td>
                        <td style="text-align:right;padding:10px 8px;">Sous-total ${chapter.name} :</td>
                        <td style="text-align:right;padding:10px 8px;font-size:12pt;">${chapterTotal.toFixed(2)} ‚Ç¨</td>
                    </tr>`;
                html += `<tr class="spacer"><td colspan="5"></td></tr>`;
            });

            html += `
                    <tr class="grand-total-row">
                        <td colspan="4">TOTAL G√âN√âRAL HT</td>
                        <td style="text-align:right;">${grandTotal.toFixed(2)} ‚Ç¨</td>
                    </tr>
                </table>
            </body>
            </html>`;

            // T√©l√©charger comme fichier .xls (compatible Excel avec styles)
            const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `devis_chubb_${new Date().toISOString().slice(0, 10)}.xls`;
            link.click();
        }

        // ============================================
        // FLASH INFO
        // ============================================
        function renderFlashInfo() {
            const query = normalize(document.getElementById('flashSearch')?.value || '');
            let filtered = flashInfo;
            if (query) {
                filtered = flashInfo.filter(f => normalize(f.title || '').includes(query));
            }

            const container = document.getElementById('flashList');
            container.innerHTML = filtered.slice(0, 50).map(f => `
            <a href="${f.url}" target="_blank" class="doc-item">
                <span style="color:var(--text-muted);min-width:40px;">${f.year || ''}</span>
                <span>${f.title || 'Sans titre'}</span>
            </a>
        `).join('');
        }

        document.getElementById('flashSearch')?.addEventListener('input', renderFlashInfo);

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', e => {
            // Escape - fermer les modals
            if (e.key === 'Escape') {
                closeModal();
                closeChapterModal();
                closeHistoryModal();
            }
            // Ctrl+F - focus recherche
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput')?.focus();
            }
            // Ctrl+S - sauvegarder devis
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (quoteChapters.length > 0) {
                    saveCurrentQuoteToHistory();
                }
            }
            // Ctrl+D - aller au devis
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                document.querySelector('[data-tab="quote"]')?.click();
            }
        });

        // ============================================
        // SORT BUTTONS UPDATE
        // ============================================
        function updateSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active', 'asc', 'desc');
                if (btn.dataset.sort === currentSortField) {
                    btn.classList.add('active', currentSortOrder);
                }
            });
        }

        // Override sortProducts to update buttons
        const originalSortProducts = sortProducts;
        sortProducts = function(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            updateSortButtons();
            performSearch();
        };

        // ============================================
        // AUTO-SAVE WRAPPER
        // ============================================
        const originalUpdateQuoteView = updateQuoteView;
        updateQuoteView = function() {
            originalUpdateQuoteView();
            saveCurrentQuote();
        };

        // Track product usage when adding to quote
        const originalAddToSpecificChapter = addToSpecificChapter;
        addToSpecificChapter = function(chapterIdx) {
            selectedProducts.forEach(p => trackProductUsage(p.code));
            originalAddToSpecificChapter(chapterIdx);
        };

        // ============================================
        // INITIALIZE
        // ============================================
        // Load saved data
        loadCurrentQuote();
        applyDarkMode();

        // Initialize display
        performSearch();
        renderFlashInfo();
        updateQuoteView();
        updateClientInfoFields();
        updateSortButtons();
    </script>

</body>

</html>
